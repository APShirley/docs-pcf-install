---
title: Using Your Own Load Balancer
owner: Ops Manager
---

<strong><%= modified_date %></strong>

This guide describes how to use your own load balancer and forward traffic to
your Elastic Runtime router IP address.

[Pivotal Cloud Foundry&reg;](https://network.pivotal.io/products/pivotal-cf)
(PCF) deploys with a single instance of HAProxy for use in lab and test
environments.
Production environments should use a highly-available customer-provided load
balancing solution that does the following:

* Provides load balancing to each of the PCF Router IPs
* Supports SSL termination with wildcard DNS location
* Adds appropriate `x-forwarded-for` and `x-forwarded-proto` HTTP headers to
incoming requests
* (**Optional**) Supports WebSockets

<p class='note'><strong>Note</strong>: Application logging with <a href="../devguide/services/log-management.html#loggregator">Loggregator</a> requires WebSockets. To use another logging service, see the <a href="../devguide/services/log-management.html#use">Using Third-Party Log Management Services</a> topic.</p>

##<a id='prerequisites'></a>Prerequisites##

To integrate your own load balancer with PCF, you must ensure the following:

* WebSocket connections are not blocked for Loggregator functionality.
* The load balancer must be able to reach the Gorouter IPs.

Follow the instructions below to use your own load balancer.

##<a id='deploy'></a>Step 1: Deploy PCF Installation VM##

Deploy a PCF Installation virtual machine.
The procedure you follow depends on the IaaS you use:

* [Deploying Operations Manager to vSphere](../customizing/deploying-vm.html)
* [Deploying Operations Manager to vCloud Air and vCloud](../customizing/pcf-vchs-vcloud.html)

##<a id='register'></a>Step 2: Register PCF IP Address##

In your load balancer, register the IP addresses that you assigned to PCF.

##<a id='configure'></a>Step 3: Configure Pivotal Ops Manager and Ops Manager Director##

Configure your Pivotal Operations Manager and Ops Manager Director as
described in [Getting Started with Pivotal Cloud Foundry&reg;](../installing/index.html), then
add Elastic Runtime.

Do not click **Install** after adding Elastic Runtime.

##<a id='configure-networking'></a>Step 4: Configure Networking 

1. In Pivotal Operations Manager, click the **Elastic Runtime** tile.

1. Select **Networking**.

	<%= image_tag 'cloudform/networking-config.png' %>

1. In the **HAProxy IPs** field, delete any existing IP addresses. This field should be blank.
 
1. In the **Router IPs** field, enter the IP address or addresses for PCF that you registered with your load balancer in Step 2.

1. Under **Configure the point-of-entry to this environment**, choose one of the following:
  * **Configure Encrypted External Load Balancer**: Select this option if your deployment uses an external load balancer that can forward encrypted traffic to the Elastic Runtime Router, or for a development environment that does not require load balancing. Complete the fields for the **Router SSL Termination Certificate and Private Key** and **Router SSL Ciphers**.
  * **Configure External Load Balancer without Encryption**: Select this option if your deployment uses an external load balancer that cannot forward encrypted traffic to the Elastic Runtime Router, or for a development environment that does not require load balancing. 
  * **Configure HAProxy**: Select this option to use HAProxy as your first point of entry. Complete the fields for **SSL Certificate and Private Key**, and **HAProxy SSL Ciphers**. Select **Disable HTTP traffic to HAProxy** if you want the HAProxy to only allow HTTPS traffic.  
  <p class="note">For details about providing SSL termination certificates and keys, see the [Providing a Certificate for your SSL Termination Point](../opsguide/security_config.html#config) topic.</p> 
1. If you are not using SSL encryption or if you are using self-signed certificates, select **Disable SSL certificate verification for this environment**.

1. Select the **Disable insecure cookies on the Router** checkbox to turn on the secure flag for cookies generated by the router.

1. In the **Choose whether or not to enable route services** section, choose either **Enable route services** or **Disable route services**.
  * If you enable route services, check **Ignore SSL certificate verification on route services** for the routing tier to reject requests that are not signed by a trusted CA. 
1. Optionally, use the **Applications Subnet** field if you need to avoid address collision with a third-party service on the same subnet as your apps. Enter a CIDR subnet mask specifying the range of available IP addresses assigned to your app containers. The IP range must be different from the network used by the system VMs.

1. Optionally, you can change the value in the **Applications Network Maximum Transmission Unit (MTU)** field. Pivotal recommends setting the MTU value for your application network to `1454`. Some configurations, such as networks that use GRE tunnels, may require a smaller MTU value.   

1. Optionally, increase the number of seconds in the **Router Timeout to Backends** field to accommodate larger uploads over connections with high latency. 

1. Click **Save**.

## <a id='finalize'></a>Step 5: Finalize Changes ##

1. Return to the **Ops Manager Installation Dashboard**

1. Click **Install**.