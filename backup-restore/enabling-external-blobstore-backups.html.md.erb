---
title: Enabling External Blobstore Backups
owner: RelEng
---

<strong><%= modified_date %></strong>

This topic describes the procedure for enabling external blobstore backups on your Pivotal Cloud Foundry (PCF) installation.

External blobstore backups leverage the versioning feature of S3-compatible storage solutions. External blobstore backups do not download the files stored in the blobstore.

For more information about the process behind backup and restore, see [Backup and Restore with External Blobstores](https://docs.cloudfoundry.org/bbr/external-blobstores.html) in the Cloud Foundry documentation.

<p class="note"><strong>Note:</strong> If you enable external blobstore backups, update your runtime config when upgrading to PCF v2.0. For more information about the runtime config, see <a href="../../../2-0/customizing/backup-restore/enabling-external-blobstore-backups.html">Enabling External Blobstore Backups</a> in the PCF v2.0 documentation.</p>

## <a id="backup-prepare"></a> Step 1: Enable Backup Prepare Node

To ensure the backup prepare node is deployed on Elastic Runtime, see [Enable Backup Prepare Node](backup-pcf-bbr.html#backup-prepare-node) in the _Backing Up Pivotal Cloud Foundry with BBR_ topic.

## <a id="s3-versioning"></a> Step 2: Set S3 Blobstore Versioning

1. Create buckets for your Elastic Runtime. For more information about creating buckets, see [Create S3 Buckets](../pcf-aws-manual-config.html#create-s3) in the _Manually Configuring AWS for PCF_ topic.

1. Enable versioning and replication. For more information, see [Enable Backup and Restore of External Blobstores](https://docs.cloudfoundry.org/bbr/external-blobstores.html) in the Cloud Foundry documentation.

1. (Optional) Pivotal recommends you include a lifecycle policy rule to delete noncurrent versions after a period of time. Including this policy rule saves storage space and cost. For an example of this rule, see [Example 6: Specifying a Lifecycle Rule for a Versioning-Enabled Bucket](https://docs.aws.amazon.com/AmazonS3/latest/dev/lifecycle-configuration-examples.html#lifecycle-config-conceptual-ex6) in the AWS documentation.

## <a id="external-blobstore"></a> Step 3: Configure an External Blobstore

To configure an external blobstore for Elastic Runtime with your S3 buckets, see [External S3 or Ceph Filestore](../pcf-aws-manual-er-config.html#external_s3) in the _Manually Configuring Elastic Runtime for AWS_ topic.

## <a id="install-addon"></a> Step 4: Install the S3 Backups Add-On

<p class="note"><strong>Note: </strong>The following steps require BOSH v2+. Check that you have downloaded the latest version of BOSH CLI. For more information, see <a href="https://bosh.io/docs/cli-v2/#install">Install</a> in the BOSH documentation.</p>

1. From the Ops Manager Installation Dashboard, click **Elastic Runtime** tile.
1. Record the slug from the URL. For example, `cf-3247176589a379f246d1`.
1. Go to [Pivotal Network](https://network.pivotal.io/) and download **Backup and Restore SDK Preview**.
1. Copy the release archive to your Ops Manager instance. See the following command line example:
  <pre class="terminal">$ scp -i PATH\_TO\_PRIVATE\_KEY backup-and-restore-sdk-preview.tar.gz ubuntu@YOUR\_OPS\_MANAGER\_VM\_IP:~</pre>
1. SSH into the Ops Manager machine. See the following command line example:
  <pre class="terminal">$ ssh -i PATH\_TO\_PRIVATE\_KEY ubuntu@YOUR\_OPS\_MANAGER\_VM\_IP</pre>
1. [Download the latest bosh CLI](https://bosh.io/docs/cli-v2.html#install), as the following bosh commands require it.
1. On the Ops Manager VM, log into your BOSH Director. The IP address can be found in Ops Manager Director > Status. When prompted, enter your BOSH Director credentials:
  ```
  $ bosh -e YOUR-BOSH-DIRECTOR-INTERNAL-IP --ca-cert /var/tempest/workspaces/default/root_ca_certificate login
  ```
  To retrieve your BOSH Director credentials, navigate to Ops Manager, click the Credentials tab, and click Link to Credential next to Director Credentials.
1. Upload the Backup and Restore SDK Preview release:
  ```
  $ bosh -e YOUR-BOSH-DIRECTOR-INTERNAL-IP --ca-cert /var/tempest/workspaces/default/root_ca_certificate upload-release backup-and-restore-sdk-preview.tar.gz
  ```
1. Confirm that the release upload has succeeded:
  ```
  $ bosh -e YOUR-BOSH-DIRECTOR-INTERNAL-IP --ca-cert /var/tempest/workspaces/default/root_ca_certificate releases
  ```
  You should see a backup-and-restore-sdk-preview entry.
1. Download your current runtime config and save it as runtime-config.yml:
  ```
  $ bosh -e YOUR-BOSH-DIRECTOR-INTERNAL-IP --ca-cert /var/tempest/workspaces/default/root_ca_certificate runtime-config > runtime-config.yml.
  ```
  If runtime-config errors with “No runtime config” just create an empty file.
1. Edit runtime-config.yml to look like the one below, replacing placeholders in <> with real values.
  <pre>
  ```releases:
  … existing release definitions …
  - name: backup-and-restore-sdk-preview
      version: <the-release-version>
  addons:
  … existing add-on definitions … 
  - name: sdk-preview
      jobs:
      - name: s3-versioned-blobstore-backup-restorer
        release: backup-and-restore-sdk-preview
        properties:
          enabled: true
          buckets:
            droplets:
              name: <name-of-droplets-bucket>
              region: <region-of-droplets-bucket>
              aws_access_key_id: <aws-access-key>
              aws_secret_access_key: <aws-secret-key>
              endpoint: <blostore-endpoint>
            packages:
              name: <name-of-packages-bucket>
              region: <region-of-packages-bucket>
              aws_access_key_id: <aws-access-key>
              aws_secret_access_key: <aws-secret-key>
              endpoint: <blostore-endpoint>
            buildpacks:
              name: <name-of-buildpacks-bucket>
              region: <region-of-buildpacks-bucket>
              aws_access_key_id: <aws-access-key>
              aws_secret_access_key: <aws-secret-key>
              endpoint: <blostore-endpoint>
      include:
        deployments:
        - <PAS-deployment-name-from-step-1>
        jobs:
        - name: mysql-backup
          release: cf-backup-and-restore
  ```
  </pre>
