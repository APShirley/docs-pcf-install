---
title: Backing Up and Restoring Pivotal Cloud Foundry
---

Refer to this topic for help backing up the contents of critical databases and
backing up and restoring your [Pivotal Cloud Foundry](https://network.pivotal.io/products/pivotal-cf) (PCF) installation settings. Pivotal recommends that you back up your installation frequently.

## <a id='settings'></a>Backing Up and Restoring Installation Settings ##

Pivotal recommends that you back up your installation settings by exporting
frequently.
Always export an installation before importing a new one.
Import an installation to restore your settings or to share your settings with
another user.

<p class="note"><strong>Note</strong>: Exporting your installation only backs up your installation settings. It does not back up your VMs or any external MySQL databases that you have configured on the Ops Manager <a href="./vsphere-config.html"><strong>Director Config</strong> page</a>.</p>

### <a id='export'></a>Exporting an Installation ###

From the Product Installation Dashboard in the Ops Manager interface, click the gear icon and select **Export installation settings**.
This option is only available after you have deployed at least one time.

<%= image_tag("action.png") %>

**Export installation settings** exports the current PCF installation
settings and assets.
When you export an installation, the exported file contains the base VM images,
necessary packages, and references to the installation IP addresses.
As a result, an export can be 5 GB or more.

<p class='note'><strong>Note</strong>: For versions of Ops Manager 1.3 or older, the process of archiving files for export may exceed the timeout limit of 600 seconds, causing a 500 error. If this happens, you can fix the problem by manually configuring the timeout value to a longer limit, or by assigning more resources to the Ops Manager VM to improve performance. Refer to the <a href='https://support.pivotal.io/hc/en-us/articles/206113627-Exporting-installation-via-Ops-Manager-failed-with-error-500-An-error-occurred-Contact-Pivotal-Technical-Support-report-the-problem-'>Knowledge Base</a> for a more in depth discussion of this issue.</p>

### <a id='import'></a>Importing an Installation ###

1. From the Product Installation Dashboard, click the gear icon and select **Import installation settings**.

1. Browse to and select a PCF installation file.

1. If the admin password has changed since the file was exported, select **Need to enter a decryption password?** before you click **Import** to prevent an error. Enter the original password that was used when the            installation was exported. If the admin password has not changed, you may skip this step.

    <%= image_tag("import-installation-file.png") %>

1. Click **Import**.

**Import installation settings** imports the settings and assets of an existing
PCF installation.
Importing an installation overwrites any existing installation.

## <a id='encrypt-key'></a>Backing Up the Cloud Controller DB Encryption Credentials ##

From the Product Installation Dashboard, select **Pivotal Elastic Runtime > Credentials** and locate the Cloud Controller section.
Record the Cloud Controller DB encryption credentials.
You must provide these credentials if you contact Pivotal Support for help
restoring your installation.

<%= image_tag("ccdb-encrypt-creds.png") %>

## <a id='manifest'></a>Download the BOSH Deployment Manifest ##

1. Install Ruby and the [BOSH CLI Ruby gem](http://docs.cloudfoundry.org/bosh/bosh-cli.html) on a machine outside of your PCF system deployment.
1. From the Installation Dashboard in Ops Manager, select **Ops Manager Director > Status** and record the IP address listed for the Ops Manager Director.
You access the BOSH Director using this IP address.

    <%= image_tag("director-ip.png") %>

1. Click **Credentials** and record the Director credentials.

    <%= image_tag("director-creds.png") %>

1. From the command line, target the BOSH Director using the IP address and credentials that you recorded:


    <pre class='terminal'>
        $ bosh target 10.0.0.3
        Target set to `microbosh-1234abcd1234abcd1234'
        Your username: director
        Enter password: ********************
        Logged in as `director'
    </pre>

    <p class="note"><strong>Note</strong>: If <code>bosh target</code> does not prompt you for your username and password, run <code>bosh login</code>.</p>

1. Run `bosh deployments` to identify the name of the current BOSH deployment:
<pre class='terminal'>
	$ bosh deployments
	+-----------------+--------------------------+-------------------------------------------------+
	| Name            | Release(s)               | Stemcell(s)                                     |
	+-----------------+--------------------------+-------------------------------------------------+
	| cf-5678dcba5678 | cf-mysql/10              | bosh-vsphere-esxi-ubuntu-trusty-go_agent/2690.3 |
	|                 | cf/183.2                 |                                                 |
	+-----------------+--------------------------+-------------------------------------------------+
</pre>

1. Run `bosh download manifest DEPLOYMENT-NAME LOCAL-SAVE-NAME` to download and
save the current BOSH deployment manifest.
You need this manifest to locate information about your databases.
Replace DEPLOYMENT-NAME with the name of the current BOSH deployment.
For this procedure, use `cf.yml` as the LOCAL-SAVE-NAME.
<pre class='terminal'>
    $ bosh download manifest cf-5678dcba5678 cf.yml
    Deployment manifest saved to `cf.yml'
</pre>

## <a id='backup-databases'></a>Backing Up Critical Databases ##

Refer to this section for help backing up and restoring databases associated
with your PCF installation.

Your Elastic Runtime deployment contains several critical data stores that must be present for a complete restore.
You must back up each of the following:

* Cloud Controller Database
* UAA Database
* Apps Manager Database
* The NFS Server
* Pivotal MySQL Server

<p class="note"><strong>Note</strong>: If you are running the default internal databases, follow the instructions below. If you are running your databases or filestores externally, disregard these instructions and ensure that you back up your external databases and filestores. </p>

### <a id='ccdb'></a>Stop Cloud Controller###
<%= partial 'stopping_cc' %>

### <a id='ccdb'></a>Back Up the Cloud Controller Database ###

1. In `cf.yml`, locate the `ccdb` component and record the IP address:

    ```
    ccdb:
	      address: 10.85.52.96
	      port: 2544
	      db_scheme: postgres
	```

1. From the Installation Dashboard in Ops Manager, select **Elastic Runtime** and click **Credentials**. Record the Cloud Controller Database credentials.

    <%= image_tag("ccdb-creds.png") %>

1. SSH into the CCDB VM as the admin using the IP address and password recorded in the previous steps.

    <pre class="terminal">
    $ ssh vcap@10.85.52.96
	Password:***********
    </pre>

1. Run `find /var/vcap | grep 'bin/psql'` to find the locally installed psql client on the CCDB VM. For example:
<pre class="terminal">
$ root@10.85.52.96:~# find /var/vcap | grep 'bin/psql'
/var/vcap/data/packages/postgres/5.1/bin/psql
</pre>

1. Run `pg_dump` from the locally installed psql client to export the database:
<pre class="terminal">
    $ /var/vcap/data/packages/postgres/5.1/bin/psql/pg_dump -h 10.85.52.96 -U admin -p 2544 ccdb > ccdb.sql
</pre>

1. Exit from the CCDB VM.

1. Run `scp` to copy the exported database to your local machine.
<pre class="terminal">
    $ scp vcap@10.85.52.96:ccdb.sql
</pre>

### <a id='backup-uaadb'></a>Back Up the UAA Database ###

1. In the BOSH deployment manifest, locate the `uaadb` component and record the IP address:

    ```
    uaadb:
          address: 10.85.52.101
          port: 2544
          db_scheme: postgresql
    ```
1. From the Installation Dashboard in Ops Manager, select **Elastic Runtime** and click **Credentials**. Record the UAA Database credentials.

    <%= image_tag("uaadb-creds.png") %>

1. SSH into the UAA DB VM as the admin using the IP address and password recorded in the previous steps.

1. Run `find /var/vcap | grep 'bin/psql'` to find the locally installed psql client on the UAA DB VM.
<pre class='terminal'>
    $ root@10.85.52.101:~# find /var/vcap | grep 'bin/psql'
    /var/vcap/data/packages/postgres/5.1/bin/psql
</pre>

1. Run `pg_dump` from the locally installed psql client to export the database:
<pre class='terminal'>
    $ /var/vcap/data/packages/postgres/5.1/bin/psql/pg_dump -h 10.85.52.101 -U root -p 2544 uaa > uaa.sql
</pre>

1. Exit from the UAA DB VM.

1. Run `scp` to copy the exported database to your local machine.
<pre class='terminal'>
    $ scp vcap@10.85.52.101:uaa.sql
</pre>


### <a id='consoledb'></a>Back Up the Apps Manager Database ###

1. In the BOSH deployment manifest, locate the `consoledb` component and record the IP address and password:

    ```
    consoledb:
      address: 10.85.52.104
      port: 2544
      db_scheme: postgresql
    ```
1. From the Installation Dashboard in Ops Manager, select **Elastic Runtime** and click **Credentials**. Record the Apps Manager Database credentials.

    <%= image_tag("appsmgr-creds.png") %>

1. SSH into the Apps Manager DB VM as the admin using the IP address and password recorded in the previous steps.

1. Run `find /var/vcap | grep 'bin/psql'` to find the locally installed psql client on the Apps Manager DB VM.
<pre class='terminal'>
	$ root@10.85.52.104:~# find /var/vcap | grep 'bin/psql'

    /var/vcap/data/packages/postgres/5.1/bin/psql
</pre>

1. Run `pg_dump` from the locally installed psql client to export the database:
<pre class='terminal'>
    $ /var/vcap/data/packages/postgres/5.1/bin/psql/pg_dump -h 10.85.52.104 -U root -p 2544 console > console.sql
</pre>

1. Exit from the Apps Manager DB.

1. Run `scp` to copy the exported database to your local machine.
<pre class='terminal'>
    $ scp vcap@10.85.52.104:console.sql
</pre>

### <a id='nfs'></a>Back Up NFS Server ###

1. In the BOSH deployment manifest, locate the `nfs_server` component and note the address:

    ```
    nfs_server:
      address: 10.0.0.10
      network: 10.0.0.0/24
    syslog_aggregator:
      address:
      port:
    ```

1. From the Installation Dashboard in Ops Manager, select **Elastic Runtime** and click **Credentials**. Record NFS Server credentials.

    <%= image_tag("nfs-creds.png") %>

1. SSH into the NFS server VM using the NFS Server and create a TAR file:
    <pre class='terminal'>
        $ ssh vcap@10.0.0.10 'cd /var/vcap/store && tar cz shared' > nfs.tar.gz
    </pre>
    <p class="note"><strong>Note</strong>: The TAR file that you create to back up the NFS server might be large. To estimate the size of the TAR file before you create it, run the following command:

    <code>tar -cf - /dir/to/archive/ | wc -c</code></p>


### <a id='runtime'></a>Back Up Pivotal MySQL Server ###

<p class="note"><strong>Note</strong>: The Elastic Runtime deploy contains an embedded MySQL Server that serves as the data store for the Application Usage Events, Notifications, and Autoscaler services.</p>

1. From the Installation Dashboard in Ops Manager, select **Pivotal Elastic Runtime**. Click **Status** and record the IP address of **MySQL Server**.

    <%= image_tag("mysql-ip.png") %>

1. Click **Credentials** and record the Mysql Admin Credentials of **MySQL Server**.

    <%= image_tag("mysql-cred.png") %>

1.  Dump the data from the p-mysql DB and save it:
<pre class='terminal'>
    $ mysqldump -u root -p -h 10.85.52.105 --all-databases > user_databases.sql
</pre>

### <a id='cc-start'></a>Start Cloud Controller ###
<%= partial 'starting_cc' %>

## <a id='restore-databases'></a>Restoring Critical Databases ##

Refer to this section for help restoring databases associated
with your PCF installation.

Your Elastic Runtime deployment contains several critical data stores that must be present for a complete restore.
You must restore each of the following:

* Cloud Controller Database
* UAA Database
* Apps Manager Database
* The NFS Server
* Pivotal MySQL Server

### <a id='stop-ccdb'></a>Stop Cloud Controller###

<%= partial 'stopping_cc' %>

### <a id='restore-uaa'></a>Restore UAA Database

#### Stop UAA

1. Find your UAA DB VM id by running <pre class='terminal'>bosh VMs</pre>

1. Using your UAA VM id, Stop UAA by running:
<pre class='terminal'>$ bosh stop YOUR-UAADB-VM-ID</pre>

#### Drop the UAADB tables

1. Login to the UAADB VM using the vcap user and password. To find this information in the Ops Manager Installation Dashboard, select **Elastic Runtime** and click **Credentials**.
<pre class='terminal'>$ ssh vcap@[YOUR-UAADB-VM-IP-ADDRESS]</pre>

1. Login to the psql client on the VM
<pre class='terminal'>$ /var/vcap/data/packages/postgres/YOUR-POSTGRES-VERSION/bin/psql -U vcap -p 2544 uaa</pre>

<p>hat is not quite right, it's not a version number; but it's easy, there should only be one folder in ../postgres/, do that one.</p>
 
1. Run the following commands to drop the tables:
<pre class='terminal'>
drop schema public cascade;
create schema public;
\q;
</pre>

1. Exit the UUADB VM
<pre class='terminal'>$ exit</pre>

#### Restore the backup

1. Use the UAA DB password and IP address to restore the UAA database by running the following commands. You can find the IP address in your BOSH deployment manifest. To find your password in the Ops Manager Installation Dashboard, select **Elastic Runtime** and click **Credentials**.
<pre class='terminal'>
$ scp uaa.sql vcap@[YOUR-UAADB-VM-IP-ADDRESS]: #UAADB server
$ ssh vcap@[YOUR-UAADB-VM-IP-ADDRESS]
$ /var/vcap/data/packages/postgres/5.1/bin/psql -U vcap -p 2544 uaa < uaa.sql
</pre>

1. Restart UAA
<pre class='terminal'>
$ bosh start YOUR-UAA-VM-UUID
</pre>

### <a id='restore-nfs'></a>Restore the NFS Server

1. Login as root user:
<pre class='terminal'>$ sudo su</pre>

1. Run the following to create a store folder if it does not exist:
<pre class='terminal'>
    [ ! -d /var/vcap/store ] && mkdir /var/vcap/store
</pre>

1. View and record the permissions on `var/vcap/store` so you can restore them after running the commands below.
<pre class='terminal'>
    ls -ld /var/vcap/store
</pre>

1. Change the permissions on `var/vcap/store` to allow all
<pre class='terminal'>
    chmod 777 /var/vcap/store
</pre>

1. Run the following command to restore the NFS Server. Find the IP address in your BOSH deployment manifest. To find your password, select the **Elastic Runtime** tile and click **Credentials**.
<pre class='terminal'>$ ssh vcap@10.0.0.10 'cd /var/vcap/store && tar zx' < nfs.tar.gz</pre>

1. Change the permissions on `var/vcap/store` back to their prior setting.
<pre class='terminal'>
    chmod YOUR-PRIOR-PERMISSION /var/vcap/store
</pre>

### <a id='restore-ccdb'></a>Restore the Cloud Controller Database

1. Use the Cloud Controller Database password and IP address to restore the Cloud Controller Database by running the following command. Find the IP address in your BOSH deployment manifest. To find your password, select the **Elastic Runtime** tile and click **Credentials**.
<pre class='terminal'>
    $ scp ccdb.sql vcap@[YOUR-CCDB-VM-IP-ADDRESS]
</pre>

1. Login to the VM as the vcap user and drop the DB
<pre class='terminal'>
$ ssh vcap@[YOUR-CCDB-VM-IP]
$ /var/vcap/data/packages/postgres/5.1/bin/psql -U vcap -p 2544 ccdb
ccdb=# drop schema public cascade;
ccdb=# create schema public;
</pre>

1. Restore the database from the backup
<pre class='terminal'>
$ /var/vcap/data/packages/postgres/5.1/bin/psql -U vcap -p 2544 ccdb < ccdb.sql
</pre>


### <a id='restore-console'></a>Restore the Console Database

1. Use the Console database password and IP address to restore the Cloud Controller Database by running the following command. Find the IP address in your BOSH deployment manifest. To find your password, select the **Elastic Runtime** tile and click **Credentials**.
<pre class='terminal'>
$ scp console.sql vcap@[YOUR-CONSOLE-DB-VM-IP-ADDRESS]
</pre>

1. Login to the VM as the vcap user and drop the db
<pre class='terminal'>
$ ssh vcap@[YOUR-CONSOLE-DB-VM-IP-ADDRESS]
$ /var/vcap/data/packages/postgres/5.1/bin/psql -U vcap -p 2544 console
console=# drop schema public cascade;
console=# create schema public;
</pre>

1. Restore the backed up database
<pre class='terminal'>
$ /var/vcap/data/packages/postgres/5.1/bin/psql -U vcap -p 2544 console < console.sql
</pre>

### <a id='restore-mysql-dev'></a>Restore Pivotal MySQL Dev

<p class='note'><strong>Note</strong>: Only follow these steps if you have installed the Pivotal MySQL Dev product tile.</p>

1. Use the Pivotal MySQL Dev database password and IP address to restore the Cloud Controller Database by running the following command. Find the IP address in your BOSH deployment manifest. To find your password, select the **Elastic Runtime** tile and click **Credentials**.
<pre class='terminal'>
  mysql -h YOUR-MYSQL-SERVER-IP -u root -p < user_databases.sql
</pre>


1. Login to MySQL and flush priveleges
<pre class='terminal'>

    $ mysql -u root -p -h
    mysql > flush privileges;
</pre>

### <a id='cc-start'></a>Start Cloud Controller ###
<%= partial 'starting_cc' %>